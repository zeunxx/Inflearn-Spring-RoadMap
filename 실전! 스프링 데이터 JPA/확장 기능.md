## ν™•μ¥ κΈ°λ¥

### μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬

- μ¤ν”„λ§ λ°μ΄ν„° JPA λ¦¬ν¬μ§€ν† λ¦¬λ” μΈν„°νμ΄μ¤λ§ μ •μν•κ³  κµ¬ν„μ²΄λ” μ¤ν”„λ§μ΄ μλ™ μƒμ„±
- μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μ κ³µν•λ” μΈν„°νμ΄μ¤λ¥Ό μ§μ ‘ κµ¬ν„ν•λ©΄ κµ¬ν„ν•΄μ•Ό ν•λ” κΈ°λ¥μ΄ λ„λ¬΄ λ§μ
- λ‹¤μ–‘ν• μ΄μ λ΅ μΈν„°νμ΄μ¤μ λ©”μ†λ“λ¥Ό μ§μ ‘ κµ¬ν„ν•κ³  μ‹¶μ„λ•!
    - JPA μ§μ ‘ μ‚¬μ©(`EntityManager`)
    - MyBatis μ‚¬μ©
    - λ°μ΄ν„°λ² μ΄μ¤ μ»¤λ„¥μ… μ§μ ‘ μ‚¬μ© λ“±λ“±...
    - Querydsl μ‚¬μ©

<br>

```
β… μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤

public interface MemberRepositoryCustom {
    List<Member> findMemberCustom();

}


β… μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ κµ¬ν„ ν΄λμ¤

@RequiredArgsConstructor
public class MemberRepositoryImpl implements MemberRepositoryCustom {

    private final EntityManager em;

    @Override
    public List<Member> findMemberCustom() {
        return em.createQuery("select m from Member m",Member.class)
                .getResultList();
    }
}


β… μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ μƒμ†

public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom{
    ...
}


β΅οΈ μ‚¬μ©μ μ •μ λ©”μ†λ“ νΈμ¶ μ½”λ“

List<Member> result = memberRepository.findMemberCustom();

```

π’΅ **μ‚¬μ©μ μ •μ κµ¬ν„ ν΄λμ¤**
- κ·μΉ™: λ¦¬ν¬μ§€ν† λ¦¬ μΈν„°νμ΄μ¤ μ΄λ¦„ + `Impl`
- μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μΈμ‹ν•΄μ„ μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅


<BR>

> μ°Έκ³ : μ‹¤λ¬΄μ—μ„λ” μ£Όλ΅ QueryDSLμ΄λ‚ SpringJdbcTemplateμ„ ν•¨κ» μ‚¬μ©ν•  λ• μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κΈ°λ¥ μμ£Ό μ‚¬μ©

> μ°Έκ³ : ν•­μƒ μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬κ°€ ν•„μ”ν• κ²ƒμ€ μ•„λ‹λ‹¤. κ·Έλƒ¥ μ„μμ λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό λ§λ“¤μ–΄λ„ λλ‹¤. 
 μλ¥Όλ“¤μ–΄ MemberQueryRepositoryλ¥Ό μΈν„°νμ΄μ¤κ°€ μ•„λ‹ ν΄λμ¤λ΅ λ§λ“¤κ³  μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•΄μ„
κ·Έλƒ¥ μ§μ ‘ μ‚¬μ©ν•΄λ„ λλ‹¤. λ¬Όλ΅  μ΄ κ²½μ° μ¤ν”„λ§ λ°μ΄ν„° JPAμ™€λ” μ•„λ¬΄λ° κ΄€κ³„ μ—†μ΄ λ³„λ„λ΅ λ™μ‘ν•λ‹¤.

<BR>

 π“**μµμ‹  μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ κµ¬ν„ ν΄λμ¤ μμ **
```
@RequiredArgsConstructor
public class MemberRepositoryCustomImpl implements MemberRepositoryCustom {

    private final EntityManager em;

    @Override
    public List<Member> findMemberCustom() {
        return em.createQuery("select m from Member m",Member.class)
                .getResultList();
    }
}

```

β΅οΈ κΈ°μ΅΄ λ°©μ‹λ³΄λ‹¤ μ΄ λ°©μ‹μ΄ μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ μ΄λ¦„κ³Ό κµ¬ν„ ν΄λμ¤ μ΄λ¦„μ΄ λΉ„μ·ν•λ―€λ΅ λ” μ§κ΄€μ μ„!

μ¶”κ°€λ΅ μ—¬λ¬ μΈν„°νμ΄μ¤λ¥Ό λ¶„λ¦¬ν•΄μ„ κµ¬ν„ν•λ” κ²ƒλ„ κ°€λ¥ν•κΈ° λ•λ¬Έμ— μƒλ΅­κ² λ³€κ²½λ μ΄ λ°©μ‹μ„ μ‚¬μ©ν•λ” κ²ƒμ„ λ” κ¶μ¥

<br>

<br>

### Auditing

- μ—”ν‹°ν‹°λ¥Ό μƒμ„±, λ³€κ²½ν•  λ• λ³€κ²½ν• μ‚¬λκ³Ό μ‹κ°„ μ¶”μ ν•κ³  μ‹¶μΌλ©΄?
    - λ“±λ΅μΌ
    - μμ •μΌ
    - λ“±λ΅μ
    - μμ •μ


<br>

β… **μμ JPA μ‚¬μ©**

```
@MappedSuperclass
@Getter
public class JpaBaseEntity {

    @Column(updatable = false)
    private LocalDateTime createdDate;
    private LocalDateTime updateDate;

    @PrePersist
    public void prePersist(){
        LocalDateTime now = LocalDateTime.now();
        createdDate = now;
        updateDate = now;
    }

    @PreUpdate
    public void preUpdate(){
        updateDate = LocalDateTime.now();
    }
}

@Entity
public class Member extends JpaBaseEntity {
    ...
}

```

- JPA μ£Όμ” μ΄λ²¤νΈ μ–΄λ…Έν…μ΄μ…
    - `@PrePersist`, `@PostPersist`
    - `@PreUpdate`, `@PostUpdate`

<br>

β… **μ¤ν”„λ§ λ°μ΄ν„° JPA μ‚¬μ©**

```
@MappedSuperclass
@Getter
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;

    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String lastModifiedBy;
}

@Entity
public class Member extends BaseEntity {
    ...
}
```

- μ„¤μ •
    - `@EnableJpaAuditing` μ¤ν”„λ§ λ¶€νΈ μ„¤μ • ν΄λμ¤μ— μ μ©ν•΄μ•Όν•¨
    - `@EntityListeners(AuditingEntityListener.class) ` μ—”ν‹°ν‹°μ— μ μ©

- μ‚¬μ© μ–΄λ…Έν…μ΄μ…
- `@CreatedDate`
- `@LastModifiedDate`
- `@CreatedBy`
- `@LastModifiedBy`

<br>
β΅οΈ λ“±λ΅μ μμ •μλ¥Ό μ²λ¦¬ν•΄μ£Όλ” `AuditorAware` μ¤ν”„λ§ λΉ λ“±λ΅

```

    @Bean
	public AuditorAware<String> auditorProvider(){
		return () -> Optional.of(UUID.randomUUID().toString());
	}

```
- μ‹¤λ¬΄μ—μ„λ” μ„Έμ… μ •λ³΄λ‚, μ¤ν”„λ§ μ‹νλ¦¬ν‹° λ΅κ·ΈμΈ μ •λ³΄μ—μ„ ID λ°›μ


> μ°Έκ³ : μ‹¤λ¬΄μ—μ„ λ€λ¶€λ¶„μ μ—”ν‹°ν‹°λ” λ“±λ΅μ‹κ°„, μμ •μ‹κ°„μ΄ ν•„μ”ν•μ§€λ§, λ“±λ΅μ, μμ •μλ” μ—†μ„ μλ„ μλ‹¤. 
κ·Έλμ„ λ‹¤μκ³Ό κ°™μ΄ Base νƒ€μ…μ„ λ¶„λ¦¬ν•κ³ , μ›ν•λ” νƒ€μ…μ„ μ„ νƒν•΄μ„ μƒμ†ν•λ‹¤

```
public class BaseTimeEntity {

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;
}

public class BaseEntity extends BaseTimeEntity{

    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String lastModifiedBy;
}

```

> μ°Έκ³ : μ €μ¥μ‹μ μ— λ“±λ΅μΌ, λ“±λ΅μλ” λ¬Όλ΅ μ΄κ³ , μμ •μΌ, μμ •μλ„ κ°™μ€ λ°μ΄ν„°κ°€ μ €μ¥λλ‹¤. λ°μ΄ν„°κ°€ μ¤‘λ³µ
μ €μ¥λλ” κ²ƒ κ°™μ§€λ§, μ΄λ ‡κ² ν•΄λ‘λ©΄ λ³€κ²½ μ»¬λΌλ§ ν™•μΈν•΄λ„ λ§μ§€λ§‰μ— μ—…λ°μ΄νΈν• μ μ €λ¥Ό ν™•μΈ ν•  μ μμΌλ―€λ΅
μ μ§€λ³΄μ κ΄€μ μ—μ„ νΈλ¦¬ν•λ‹¤. μ΄λ ‡κ² ν•μ§€ μ•μΌλ©΄ λ³€κ²½ μ»¬λΌμ΄ null μΌλ• λ“±λ΅ μ»¬λΌμ„ λ μ°Ύμ•„μ•Ό ν•λ‹¤.
> μ°Έκ³ λ΅ μ €μ¥μ‹μ μ— μ €μ¥λ°μ΄ν„°λ§ μ…λ ¥ν•κ³  μ‹¶μΌλ©΄ @EnableJpaAuditing(modifyOnCreate = false)
μµμ…μ„ μ‚¬μ©ν•λ©΄ λλ‹¤.

<br><br>

### μ›Ή ν™•μ¥

#### 1οΈβƒ£ **λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°**

HTTP νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ μ—”ν‹°ν‹°μ μ•„μ΄λ””λ΅ μ—”ν‹°ν‹° κ°μ²΄λ¥Ό μ°Ύμ•„ λ°”μΈλ”©

```
β… λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„° μ‚¬μ© μ „
    
    @GetMapping("/members/{id}")
    public String findMember(@PathVariable("id") long id){
        Member member = memberRepository.findById(id).get();
        return member.getUsername();
    }

β… λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„° μ‚¬μ© ν›„

    @GetMapping("/members2/{id}")
    public String findMember2(@PathVariable("id") Member member){
        return member.getUsername();
    }
```
- HTTP μ”μ²­μ€ νμ› `id`λ¥Ό λ°›μ§€λ§ λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°κ°€ μ¤‘κ°„μ— λ™μ‘ν•΄μ„ νμ› μ—”ν‹°ν‹° κ°μ²΄λ¥Ό λ°ν™
- λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°λ„ λ¦¬νμ§€ν† λ¦¬λ¥Ό μ‚¬μ©ν•΄μ„ μ—”ν‹°ν‹°λ¥Ό μ°Ύμ

<br>

> μ£Όμ: λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°λ΅ μ—”ν‹°ν‹°λ¥Ό νλΌλ―Έν„°λ΅ λ°›μΌλ©΄, μ΄ μ—”ν‹°ν‹°λ” λ‹¨μ μ΅°νμ©μΌλ΅λ§ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤. 
(νΈλμ­μ…μ΄ μ—†λ” λ²”μ„μ—μ„ μ—”ν‹°ν‹°λ¥Ό μ΅°νν–μΌλ―€λ΅, μ—”ν‹°ν‹°λ¥Ό λ³€κ²½ν•΄λ„ DBμ— λ°μλμ§€ μ•λ”λ‹¤.)

<br>

#### 2οΈβƒ£ **νμ΄μ§•κ³Ό μ •λ ¬**

μ¤ν”„λ§ λ°μ΄ν„°κ°€ μ κ³µν•λ” νμ΄μ§•κ³Ό μ •λ ¬ κΈ°λ¥μ„ μ¤ν”„λ§ MVCμ—μ„ νΈλ¦¬ν•κ² μ‚¬μ© κ°€λ¥
```
    @GetMapping("/members")
    public Page<Member> list(Pageable pageable){
        return memberRepository.findAll(pageable);
    }

```

- νλΌλ―Έν„°λ΅ `Pageable`μ„ λ°›μ„ μ μμ
- `Pageable`μ€ μΈν„°νμ΄μ¤, , μ‹¤μ λ” `org.springframework.data.domain.PageRequest` κ°μ²΄ μƒμ„±

<br>

- μ”μ²­ νλΌλ―Έν„°
    - ex) `/members?page=0&size=3&sort=id,desc&sort=username,desc`
    - page: ν„μ¬ νμ΄μ§€, 0λ¶€ν„° μ‹μ‘
    - size: ν• νμ΄μ§€μ— λ…Έμ¶ν•  λ°μ΄ν„° κ±΄μ
    - sort: μ •λ ¬ μ΅°κ±΄ μ •μ ex) μ •λ ¬ μ†μ„± (asc,desc ..), μ •λ ¬ λ°©ν–¥μ„ λ³€κ²½ν•κ³  μ‹¶μΌλ©΄ sort νλΌλ―Έν„° μ¶”κ°€

<br>

- κΈ°λ³Έκ°’
    - κΈ€λ΅λ² μ„¤μ •: μ¤ν”„λ§ λ¶€νΈ
    ```
    β… application.yml

        spring:
          data:
            web:
            pageable:
                default-page-size: 10
                max-page-size: 2000
    ```

    - κ°λ³„ μ„¤μ • : `@PageableDefault` μ–΄λ…Έν…μ΄μ… μ‚¬μ©
    ```
    @GetMapping("/members")
    public Page<Member> list(@PageableDefault(size=5) Pageable pageable){
        return memberRepository.findAll(pageable);
    }
    ```
<br>

- μ ‘λ‘μ‚¬
    - νμ΄μ§• μ •λ³΄κ°€ λ‘ μ΄μƒμ΄λ©΄ μ ‘λ‘μ‚¬λ΅ κµ¬λ¶„
    - `@Qualifier`μ— μ ‘λ‘μ‚¬λ… μ¶”κ°€ "(μ ‘λ‘μ‚¬λ…)_xxx"
    - ex) `/members?member_page=0&order_page=1`
    ```
    public String list(
        @Qualifier("member") Pageable memberPageable,
        @Qualifier("order") Pageable orderPageable, ...

    ```

<br>

- Page λ‚΄μ©μ„ DTOλ΅ λ³€ν™ν•κΈ°
    - Pageλ” map()μ„ μ§€μ›ν•΄μ„ λ‚΄λ¶€ λ°μ΄ν„°λ¥Ό λ‹¤λ¥Έ κ²ƒμΌλ΅ λ³€κ²½ κ°€λ¥!
    ```
    @GetMapping("/members")
    public Page<MemberDto> list(@PageableDefault(size=5) Pageable pageable){
        Page<Member> page = memberRepository.findAll(pageable);
        Page<MemberDto> map = page.map(member -> new MemberDto(member.getId(), member.getUsername(), null));
        return map;
    }
    ```

<BR>

- Pageλ¥Ό 1λ¶€ν„° μ‹μ‘ν•κΈ°
    - μ¤ν”„λ§ λ°μ΄ν„°λ” Pageλ¥Ό 0λ¶€ν„° μ‹μ‘ν•λ”λ°, 1λ¶€ν„° ν•κ³  μ‹¶λ‹¤λ©΄?

    1. Pageable, Pageλ¥Ό νλΌλ―Έν„°μ™€ μ‘λ‹µ κ°’μΌλ΅ μ‚¬μ©ν•μ§€ μ•κ³ , μ§μ ‘ ν΄λμ¤λ¥Ό λ§λ“¤μ–΄ μ²λ¦¬

    μ§μ ‘ PageRequest(Pageable κµ¬ν„μ²΄)λ¥Ό μƒμ„±ν•΄μ„ λ¦¬ν¬μ§€ν† λ¦¬μ— λ„κΈ΄λ‹¤. λ¬Όλ΅  μ‘λ‹µκ°’λ„ Page λ€μ‹ μ— μ§μ ‘ λ§λ“¤μ–΄μ„ μ κ³µ

    2. `spring.data.web.pageable.one-indexed-parameters` λ¥Ό true λ΅ μ„¤μ •, but μ΄ λ°©λ²•μ€ webμ—μ„ page νλΌλ―Έν„°λ¥Ό -1λ΅ μ²λ¦¬ν• λΏμ„. λ”°λΌμ„ μ‘λ‹µκ°’μΈ Pageμ— λ¨λ‘ 0 νμ΄μ§€ μΈλ±μ¤λ¥Ό μ‚¬μ©ν•λ” ν•κ³„κ°€ μμ

    ```
    β΅οΈ page 1 μ”μ²­
    {
        "content": [
        ...
        ],
        "pageable": {
            "offset": 0,
            "pageSize": 10,
            "pageNumber": 0 //0 μΈλ±μ¤(1λ΅ μ”μ²­ν•΄λ„ 0μΌλ΅ λΈ)
        },
        "number": 0, //0 μΈλ±μ¤
        "empty": false
    }

    ```