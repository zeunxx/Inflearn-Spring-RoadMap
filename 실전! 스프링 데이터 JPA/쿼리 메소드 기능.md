## ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥



### 1ï¸âƒ£ ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±

```
ğŸ’¡ ìˆœìˆ˜ spring jpa ë ˆí¬ì§€í† ë¦¬

    public List<Member> findByUsernameAndAgeGreaterThan(String username, int age) {
        return em.createQuery("select m from Member m where m.username = :username and m.age > :age")
                .setParameter("username", username)
                .setParameter("age", age)
                .getResultList();
    }

ğŸ’¡ spring data jpa ë ˆí¬ì§€í† ë¦¬

    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);

```
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQLì„ ìƒì„±í•˜ê³  ì‹¤í–‰

<BR>

âœ… ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥

- ì¡°íšŒ: findâ€¦By ,readâ€¦By ,queryâ€¦By getâ€¦By, 
    - EX) findHelloBy ì²˜ëŸ¼ ...ì— ì‹ë³„í•˜ê¸° ìœ„í•œ ë‚´ìš©(ì„¤ëª…)ì´ ë“¤ì–´ê°€ë„ ëœë‹¤.
- COUNT: countâ€¦By ë°˜í™˜íƒ€ì… long
- EXISTS: existsâ€¦By ë°˜í™˜íƒ€ì… boolean
- ì‚­ì œ: deleteâ€¦By, removeâ€¦By ë°˜í™˜íƒ€ì… long
- DISTINCT: findDistinct, findMemberDistinctBy
- LIMIT: findFirst3, findFirst, findTop, findTop3

<BR>

> ì°¸ê³ : ì´ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ë©”ì„œë“œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤. 
ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.
> ì´ë ‡ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìŠ¤í”„ë§ ë°ì´í„° JPAì˜ ë§¤ìš° í° ì¥ì ì´ë‹¤.

<BR>

### 2ï¸âƒ£ ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ
- ì‹¤ë¬´ì—ì„œ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

```
ğŸ’¡ ì—”í‹°í‹°

    @Entity
    @NamedQuery(
        name="Member.findByUsername",
        query = "select m from Member m where m.username = :username"
    )
    public class Member {

        @Id @GeneratedValue
        @Column(name="member_id")
        private Long id;
        ...

    }

ğŸ’¡ ìˆœìˆ˜ spring jpa ë ˆí¬ì§€í† ë¦¬ 

    public List<Member> findByUsername(String username){
        return em.createNamedQuery("Member.findByUsername",Member.class)
                .setParameter("username",username)
                .getResultList();
    }

ğŸ’¡ spring data jpa ë ˆí¬ì§€í† ë¦¬

    @Query(name = "Member.findByUsername") // @Query ë¥¼ ìƒëµí•˜ê³  ë©”ì„œë“œ ì´ë¦„ë§Œìœ¼ë¡œ Named ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŒ!
    List<Member> findByUsername(@Param("username") String username);

```

- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ì„ ì–¸í•œ "ë„ë©”ì¸ í´ë˜ìŠ¤ + .(ì ) + ë©”ì„œë“œ ì´ë¦„"ìœ¼ë¡œ Named ì¿¼ë¦¬ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰
- ë§Œì•½ ì‹¤í–‰í•  Named ì¿¼ë¦¬ê°€ ì—†ìœ¼ë©´ ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ì „ëµì„ ì‚¬ìš©
- í•„ìš”í•˜ë©´ ì „ëµì„ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ ê¶Œì¥í•˜ì§€ ì•ŠìŒ!

<br>

### 3ï¸âƒ£ @Query ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ ë¦¬íŒŒì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜

```
ğŸ’¡ spring data jpa ë ˆí¬ì§€í† ë¦¬

    @Query("select m from Member m where m.username = :username and m.age = :age")
    List<Member> findUser(@Param("username") String username, @Param("age") int age);
```
- ì‹¤í–‰í•  ë©”ì„œë“œì— ì •ì  ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ë¯€ë¡œ ì´ë¦„ ì—†ëŠ” Named ì¿¼ë¦¬ë¼ í•  ìˆ˜ ìˆìŒ
- JPA Named ì¿¼ë¦¬ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆìŒ(ë§¤ìš° í° ì¥ì !)

<br>

> ì°¸ê³ : ì‹¤ë¬´ì—ì„œëŠ” ```ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ê¸°ëŠ¥```ì€ íŒŒë¼ë¯¸í„°ê°€ ì¦ê°€í•˜ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ë”°ë¼ì„œ @Query ê¸°ëŠ¥ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤


<br>

### âœ… @Queryë¡œ ê°’, DTO ì¡°íšŒí•˜ê¸° 

#### 1. ë‹¨ìˆœíˆ ê°’ í•˜ë‚˜ë¥¼ ì¡°íšŒ

```
    @Query("select m.username from Member m")
    List<String> findUsernameList();
```

#### 2. DTO ì¡°íšŒ

```
    @Query("select new study.datajpa.dto.MemberDto(m.id, m.username, t.name) from Member m join m.team t")
    List<MemberDto> findMemberDto();
```

<br>

### íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

- ìœ„ì¹˜ ê¸°ë°˜
- ì´ë¦„ ê¸°ë°˜


```
select m from Member m where m.username = ?0 //ìœ„ì¹˜ ê¸°ë°˜
select m from Member m where m.username = :name //ì´ë¦„ ê¸°ë°˜


@Query("select m from Member m where m.username = :name")
Member findMembers(@Param("name") String username);

```


> ì°¸ê³ : ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ì´ë¦„ ê¸°ë°˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ì (ìœ„ì¹˜ê¸°ë°˜ì€ ìˆœì„œ ì‹¤ìˆ˜ê°€
ë°”ê¾¸ë©´â€¦)


<br>

ğŸ’¡ **ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©**
- Collection íƒ€ì…ìœ¼ë¡œ inì ˆ ì§€ì›

```
@Query("select m from Member m where m.username in :names")
List<Member> findByNames(@Param("names") List<String> names);
```

<br><Br>

### ë°˜í™˜ íƒ€ì…

- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì… ì§€ì›
```
    List<Member> findListByUsername(String username); // ì»¬ë ‰ì…˜
    Member findMemberByUsername(String username); // ë‹¨ê±´
    Optional<Member> findOptionalByUsername(String username); // ë‹¨ê±´ Optional
```

 ğŸ“Œì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì—†ìœ¼ë©´?
- ì»¬ë ‰ì…˜
    - ê²°ê³¼ ì—†ìŒ: ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜
- ë‹¨ê±´ ì¡°íšŒ
    - ê²°ê³¼ ì—†ìŒ: null ë°˜í™˜
    - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ: javax.persistence.NonUniqueResultException ì˜ˆì™¸ ë°œìƒ

> ì°¸ê³ : ë‹¨ê±´ìœ¼ë¡œ ì§€ì •í•œ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‚´ë¶€ì—ì„œ JPQLì˜
Query.getSingleResult() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´
javax.persistence.NoResultException ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ë° ê°œë°œì ì…ì¥ì—ì„œ ë‹¤ë£¨ê¸°ê°€ ìƒë‹¹íˆ
ë¶ˆí¸í•˜ë‹¤. ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‹¨ê±´ì„ ì¡°íšŒí•  ë•Œ ì´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ëŒ€ì‹ ì— null ì„
ë°˜í™˜í•œë‹¤.

<br><BR>

### ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

: ê¸°ì¡´ JPA ëŠ” ë”í‹° ì²´í‚¹ì„ í†µí•´ DBë¥¼ ìˆ˜ì •í•˜ëŠ”ë°, ì´ê²ƒì€ í•˜ë‚˜ì”© ë¹„êµí•´ê°€ë©° ë°”ë€ ë¶€ë¶„ updateí•¨!

í•œë²ˆì— ìˆ˜ì •í•˜ê³  ì‹¶ì„ë• ë¹„íš¨ìœ¨ì  â¡ï¸ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ ì‚¬ìš©

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ê±°ì¹˜ì§€ ì•Šê³  ë°”ë¡œ DBì— UPDATE ì¿¼ë¦¬ ë‚ ë¦¼!!
<BR>


```
ğŸ’¡ ìˆœìˆ˜ spring jpa ë ˆí¬ì§€í† ë¦¬ 

    public int bulkAgePlus(int age){
        return em.createQuery("update Member m set m.age = m.age+1" +
                        " where m.age >= :age")
                .setParameter("age", age)
                .executeUpdate();
    }

ğŸ’¡ spring data jpa ë ˆí¬ì§€í† ë¦¬

    // bulk ìˆ˜ì • ì¿¼ë¦¬
    @Modifying(clearAutomatically = true) // ì¿¼ë¦¬ì‹¤í–‰ì‹œ ëª‡ê°œì˜ ì—”í‹°í‹°ì— ì ìš©ëëŠ”ì§€ ë¦¬í„´í•´ì¤Œ (executeUpdate)
    @Query("update Member m set m.age = m.age + 1 where m.age >= :age")
    int bulkAgePlus(@Param("age") int age);
```

- ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” @Modifying ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©
    - ì‚¬ìš©í•˜ì§€ ì•Šì„ì‹œ ```org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations``` ì—ëŸ¬ ë°œìƒ
- ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” : ```@Modifying(clearAutomatically = true)``` (ê¸°ë³¸ê°’ì€ false)
    - ì´ ì˜µì…˜ì—†ì´ íšŒì›ì„ findByIdë¡œ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê³¼ê±° ê°’ì´ ë‚¨ì•„ì„œ ë¬¸ì œ ë  ìˆ˜ ìˆìŒ. ë§Œì•½ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•˜ë©´ ê¼­ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”!!!

<br>

> ì°¸ê³ : ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ì˜ ìƒíƒœì™€ DBì— ì—”í‹°í‹° ìƒíƒœê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.
> ê¶Œì¥í•˜ëŠ” ë°©ì•ˆ
> 1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
> 2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•œë‹¤

<br><br>

### @EntityGraph

ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë°©ë²•

member â†’ teamì€ ì§€ì—°ë¡œë”© ê´€ê³„ì„. ë”°ë¼ì„œ ì›ë˜ëŠ” teamì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí• ë•Œë§ˆë‹¤ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë¨ (N+1 ë¬¸ì œ ë°œìƒ)

â¡ï¸ fetch join ì‚¬ìš©!

ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPAê°€ ì œê³µí•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ ë„ì™€ì¤Œ

ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ JPQLì—†ì´ í˜ì¹˜ ì¡°ì¸ ì‚¬ìš© ê°€ëŠ¥(JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ë„ ê°€ëŠ¥)
```
    // JPQL ì‚¬ìš©í•´ì„œ í˜ì¹˜ ì¡°ì¸
    @Query("select m from Member m left join fetch m.team")
    List<Member> findMemberFetchJoin();

    // ê³µí†µ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
    @Override
    @EntityGraph(attributePaths = {"team"})
    List<Member> findAll();

    // JPQL + ì—”í‹°í‹° ê·¸ë˜í”„
    @EntityGraph(attributePaths = {"team"})
    @Query("select m from Member m ")
    List<Member> findMemberEntityGraph();

    // ë©”ì„œë“œ ì´ë¦„ ì¿¼ë¦¬ + í˜ì¹˜ ì¡°ì¸(íŠ¹íˆ í¸ë¦¬!)
    @EntityGraph(attributePaths = {"team"})
    List<Member> findEntityGraphByUsername(@Param("username") String username);

â¡ï¸ ë™ì¼ ì¿¼ë¦¬ ì‹¤í–‰ë¨ 
```

ğŸ“Œ **EntityGraph ì •ë¦¬**
- ì‚¬ì‹¤ìƒ í˜ì¹˜ì¡°ì¸ì˜ ê°„í¸ ë²„ì „
- left outer join ì‚¬ìš©

<br><Br>

### JPA Hint & Lock

#### âœ… JPA Hint
JPA ì¿¼ë¦¬ íŒíŠ¸(SQL íŒíŠ¸ê°€ ì•„ë‹ˆë¼ JPA êµ¬í˜„ì²´ì—ê²Œ ì œê³µí•˜ëŠ” íŒíŠ¸)

```
    @QueryHints(value = @QueryHint(name="org.hibernate.readOnly",value="true"))
    Member findReadOnlyByUsername(String username);
```
```
    @Test
    Member findMember = memberRepository.findReadOnlyByUsername("member1");
        findMember.setUsername("member2"); // ë³€ê²½ ì•ˆë¨(update ì¿¼ë¦¬ ì•ˆë‚˜ê°)

        em.flush();
```

- ```org.springframework.data.jpa.repository.QueryHints ```ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
- forCounting : ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ Page ì¸í„°í˜ì´ìŠ¤ë¥¼ ì ìš©í•˜ë©´ ì¶”ê°€ë¡œ í˜¸ì¶œí•˜ëŠ” í˜ì´ì§•ì„ ìœ„í•œ count ì¿¼ë¦¬ë„ ì¿¼ë¦¬ íŒíŠ¸ ì ìš©(ê¸°ë³¸ ê°’  true)


<br>

#### âœ… JPA Lock

```
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    List<Member> findLockByUsername(String username);
```
- ```org.springframework.data.jpa.repository.Lock ```ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
