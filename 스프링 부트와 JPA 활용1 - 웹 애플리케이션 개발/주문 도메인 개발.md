

### ì£¼ë¬¸ ë„ë©”ì¸ ê°œë°œ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‘ì„±

```
@Entity
public class Order {

    ...

    //==ìƒì„± ë©”ì†Œë“œ==//
    public static Order createOrder(Member member, Delivery delivery, OrderItem... orderItems){
        Order order = new Order();
        order.setMember(member);
        order.setDelivery(delivery);
        for(OrderItem orderItem : orderItems){
            order.addOrderItem(orderItem);
        }
        order.setStatus(OrderStatus.ORDER);
        order.setOrderDate(LocalDateTime.now());
        return order;
    }

    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    public void cancel(){
        if(delivery.getStatus() == DeliveryStatus.COMP){
            // ì´ë¯¸ ë°°ì†¡ ì™„ë£Œë©´ ì·¨ì†Œ ë¶ˆê°€
            throw new IllegalStateException("ì´ë¯¸ ë°°ì†¡ ì™„ë£Œëœ ìƒí’ˆì€ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
        
        this.setStatus(OrderStatus.CANCEL); // ìƒíƒœ ë³€ê²½
        for(OrderItem orderItem: orderItems){
            orderItem.cancel(); // ê°ê°ì˜ ìƒí’ˆì„ ì·¨ì†Œ í•´ì„œ ì¬ê³  ë³µêµ¬
        }
    }
    
    //== ì¡°íšŒ ë¡œì§ ==//
    /**
     * ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ
     */
    public int getTotalPrice(){
        int totalPrice = orderItems.stream().mapToInt(OrderItem::getTotalPrice).sum();
//        for(OrderItem orderItem : orderItems){
//            totalPrice+= orderItem.getTotalPrice(); // í•œ ìƒí’ˆì„ ì—¬ëŸ¬ê°œ ì‚´ ìˆ˜ ìˆìœ¼ë‹ˆ ê° orderItemì˜ ì´ ê°€ê²© ë”í•¨
//        }

        // í•œ ìƒí’ˆì„ ì—¬ëŸ¬ê°œ ì‚´ ìˆ˜ ìˆìœ¼ë‹ˆ ê° orderItemì˜ ì´ ê°€ê²© ë”í•¨
        return totalPrice;
    }
}

```

<br>

#### 1. ìƒì„± ë©”ì†Œë“œ : **static**
- ë°–ì—ì„œ orderë¥¼ newí•´ì„œ setí•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ì•„ì˜ˆ order ìƒì„±í• ë•Œë¶€í„° createOrderë¥¼ í˜¸ì¶œí•´ì•¼í•¨
- ìƒì„± ë©”ì†Œë“œì—ì„œ ì£¼ë¬¸ ìƒì„±ì— ëŒ€í•œ ë³µì¡í•œ ë¡œì§ì„ ë‹¤ ì‘ì§‘í•´ ë†“ìŒ
- ì£¼ë¬¸ ìƒì„±ì— ëŒ€í•´ ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ createOrderë§Œ ê³ ì¹˜ë©´ ë¨

#### 2. ì£¼ë¬¸ ì·¨ì†Œ
- ì´ë¯¸ ë°°ì†¡ ì™„ë£Œëœ ì£¼ë¬¸ì€ ì·¨ì†Œí•˜ì§€ ëª»í•˜ê²Œ ì²´í¬í•´ ë†“ìŒ
    - entityì•ˆì— ë„£ì–´ë†ˆ
- ê°ê°ì˜ orderItemì„ cancelí•˜ë©´ orderItem ë„ë©”ì¸ ë‚´ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§(cancel)ì´ ì‹¤í–‰ë˜ì–´ ì¬ê³  ë³µêµ¬ 
    - ì£¼ë¬¸í• ë• removeStockì´ í˜¸ì¶œ, ì·¨ì†Œí• ë• addStockì´ í˜¸ì¶œ


#### 3. ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ
- ê°ê°ì˜ orderItemì˜ ìˆ˜ëŸ‰*ê°€ê²©ì„ í•©ì³ì„œ ì´ ê¸ˆì•¡ ë¦¬í„´


<br>

#### â• orderItemì˜ ìƒì„±ë©”ì†Œë“œ (**static**)
```
    //== ìƒì„± ë©”ì†Œë“œ ==//
    public static OrderItem createOrderItem(Item item, int orderPrice, int count){
        OrderItem orderItem = new OrderItem();
        orderItem.setItem(item);
        orderItem.setOrderPrice(orderPrice); // ì£¼ë¬¸ ë‹¹ì‹œ ê°€ê²©(í• ì¸ ë“±ìœ¼ë¡œ ì¸í•´ ê¸°ì¡´ ê°€ê²©ì—ì„œ ë³€ê²½ë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ)
        orderItem.setCount(count);
        
        item.removeStock(count); // ì•„ì´í…œ ì¬ê³  ì¤„ì„
        return orderItem;
    }

```
: orderItem ìƒì„±í•˜ë©´ì„œ itemì˜ ì¬ê³ ë„ ì¤„ì„

ğŸ“Œ ëˆ„êµ°ê°€ê°€ ëª¨ë¥´ê³  ì´ ìƒì„± ë©”ì†Œë“œë¥¼ ì‚¬ìš©ì•ˆí•œë‹¤ë©´?
```
OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);

â¡ï¸ ì´ ë°©ì‹ì„ ì‚¬ìš©í•´ì•¼í•¨ 

BUT,

OrderItem orderItem = new OrderItem();
orderItem.setItem(item);
...

â¡ï¸ ìœ„ì˜ ë°©ì‹ì„ ë§‰ê¸° ìœ„í•´ OrderItemì— ë¡¬ë³µ ì ìš©!

@Entity
@Getter @Setter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class OrderItem {
    ...
}

: ê¸°ë³¸ ìƒì„±ìë¥¼ protecedë¡œ ìƒì„±í•´ ê¸°ë³¸ ìƒì„±ì ë§Œë“¤ì§€ ëª»í•˜ê²Œ ë§‰ìŒ!
```


<br><br>

### ì£¼ë¬¸ ì„œë¹„ìŠ¤ ìƒì„±
```
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final MemberRepository memberRepository;
    private final ItemRepository itemRepository;

    /**
     * ì£¼ë¬¸
     */
    @Transactional
    public Long order(Long memberId, Long itemId, int count){

        // ì—”í‹°í‹° ì¡°íšŒ
        Member member = memberRepository.findOne(memberId);
        Item item = itemRepository.findOne(itemId);

        // ë°°ì†¡ì •ë³´ ìƒì„±
        Delivery delivery = new Delivery();
        delivery.setAddress(member.getAddress());

        // ì£¼ë¬¸ ìƒí’ˆ ìƒì„± (static ìƒì„± ë©”ì†Œë“œ ì‚¬ìš©)
        OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);

        // ì£¼ë¬¸ ìƒì„± (static ìƒì„± ë©”ì†Œë“œ ì‚¬ìš©)
        Order order = Order.createOrder(member, delivery, orderItem);

        // ì£¼ë¬¸ ì €ì¥
        orderRepository.save(order);
        
        return order.getId();
    }

    ...
}
```

#### 1ï¸âƒ£ ì£¼ë¬¸ 

- ì›ë˜ Deliveryì™€ OrderItem, Order ëª¨ë‘ ê°ê° Repository ìƒì„±í•´ì„œ persistí•´ì•¼í•¨ 
    
    but Orderì—ì„œë§Œ saveí•¨

    â¡ï¸ Orderì—ì„œ OrderItemê³¼ Deliveryë¥¼ cascade ì…‹íŒ…! ë”°ë¼ì„œ Orderë¥¼ save(persist)í•˜ë©´ ì–˜ë„¤ ë‘˜ë‹¤ ê°•ì œë¡œ persist ë¨!! 

    = cascade ì˜µì…˜ìœ¼ë¡œ orderë¥¼ ì €ì¥í• ë•Œ orderItemê³¼ delivery ì •ë³´ ëª¨ë‘ DBì— ì €ì¥(INSERT)!

<br>

##### ğŸ“Œ cascadeì˜ ë²”ìœ„?
- orderê°€ deliveryë¥¼ ê´€ë¦¬í•˜ê³ /orderItemì„ ê´€ë¦¬í•¨
    - orderë§Œ deliveryì™€ orderItemì„ ì°¸ì¡°í•´ì„œ ì‚¬ìš©
    - ë§Œì•½ ë‹¤ë¥¸ ê°ì²´ê°€ deliveryë¥¼ ì°¸ì¡°í•˜ëŠ” ë“± ì¤‘ìš”í•œ entityë¼ë©´ ì‚¬ìš© x!
- ì´ì •ë„ ë²”ìœ„ë§Œ casecade ì ìš©!

<br>

#### 2ï¸âƒ£ ì£¼ë¬¸ ì·¨ì†Œ
```
    /**
     * ì·¨ì†Œ
     */
    @Transactional
    public void cancelOrder(Long orderId){
        // ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
        Order order = orderRepository.findOne(orderId);
        // ì£¼ë¬¸ ì·¨ì†Œ
        order.cancel();
        
        
    }

```

- JPAë¥¼ ì‚¬ìš© ì•ˆí•˜ë©´ cancelì„ í†µí•´ statusë¥¼ ë°”ê¾¸ê³  dbì— updateí•˜ëŠ” ë¡œì§ ì§œì•¼í•¨
- but, JPAë¥¼ í™œìš©í•˜ë©´ entityë‚´ì˜ ë°ì´í„°ë¥¼ ë°”ê¾¸ë©´ JPAê°€ ì•Œì•„ì„œ ë³€ê²½ ê°ì§€í•´ DBì— ì—…ë°ì´íŠ¸ í•´ì¤Œ


<br>

#### ğŸ“Œ ì°¸ê³ : ì£¼ë¬¸ ì„œë¹„ìŠ¤ì˜ ì£¼ë¬¸ê³¼ ì£¼ë¬¸ ì·¨ì†Œ ë©”ì„œë“œë¥¼ ë³´ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ëŒ€ë¶€ë¶„ì´ ì—”í‹°í‹°ì— ìˆë‹¤. (ex. createOrderItem)

> ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë‹¨ìˆœíˆ ì—”í‹°í‹°ì— í•„ìš”í•œ ìš”ì²­ì„ ìœ„ì„í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ì´ì²˜ëŸ¼ ì—”í‹°í‹°ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§€ê³ 
ê°ì²´ ì§€í–¥ì˜ íŠ¹ì„±ì„ ì ê·¹ í™œìš©í•˜ëŠ” ê²ƒì„ ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ì´ë¼ í•œë‹¤. ë°˜ëŒ€ë¡œ ì—”í‹°í‹°ì—ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ê±°ì˜ ì—†ê³  ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ
ëŒ€ë¶€ë¶„ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´ì´ë¼ í•œë‹¤.

- ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ http://martinfowler.com/eaaCatalog/domainModel.html

- íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´ http://martinfowler.com/eaaCatalog/transactionScript.html


<br><br>

â• í…ŒìŠ¤íŠ¸ ì‘ì„±
: entityë‚´ì— ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆê¸° ë•Œë¬¸ì— entity ìì²´ì— ëŒ€í•´ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ(entity ìì²´ê°€ ì˜ ë™ì‘í•˜ëŠ”ì§€ DB, repositoryì™€ ê´€ê³„ì—†ì´!)