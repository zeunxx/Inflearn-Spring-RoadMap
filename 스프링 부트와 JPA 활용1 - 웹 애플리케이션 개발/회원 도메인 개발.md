
### íšŒì› repository

<br>

```
@Repository
public class MemberRepository {

    @PersistenceContext
    private EntityManager em;

    public void save(Member member){
        em.persist(member);
    }

    public Member findOne(Long id){
        return em.find(Member.class,id);
    }

    public List<Member> findAll(){
        return em.createQuery("select m from Member m", Member.class)
                .getResultList(); // ì¿¼ë¦¬ ê²°ê³¼ ë°›ì•„ì˜´
    }
    
    public List<Member> findByName(String name){
        return em.createQuery("select m from Member m where m.name = :name", Member.class)
                .setParameter("name",name) // íŒŒë¼ë¯¸í„° ë°”ì¸ë”©
                .getResultList();
    }
}

```
<BR>

- @Repository : ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ì‹œì¼œì¤Œ
- @PersistenceContext : entity manager ì£¼ì… 




<br>

#### 1. SQLê³¼ JPQL
- SQL : tableì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ ë‚ ë¦¼
- JPQL : entity ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ ë‚ ë¦¼

<br>

#### 2. ìƒì„±ì

```
@Repository
@RequiredArgsConstructor
public class MemberRepository {

//    @PersistenceContext //@Autowiredë¡œ ë³€ê²½ ê°€ëŠ¥
//    private EntityManager em;
    
    private final EntityManager em;
    
```
- @PersistenceContextê°€ @Autowiredë¡œ ë³€ê²½ ê°€ëŠ¥í•´ì„œ ìƒëµ ê°€ëŠ¥í•˜ê³ (ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ DataJPAê°€ ì§€ì›í•´ì¤Œ!)
- ë¡¬ë³µ @RequiredArgsConstructor ì‚¬ìš© ê°€ëŠ¥

<br><br>

### íšŒì› service
```
@Service
@Transactional(readOnly = true)
public class MemberService {

    private final MemberRepository memberRepository;
    // ì»´íŒŒì¼ ì‹œì ì— í™•ì¸ ê°€ëŠ¥í•˜ë¯€ë¡œ final ì ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ


    @Autowired // ìƒëµ ê°€ëŠ¥
    public MemberService(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    } // ìƒì„±ì ì£¼ì…ì´ ì¢‹ìŒ!! 

    /**
     * íšŒì› ê°€ì…
     */
    @Transactional
    public Long join(Member member){

        validateDuplicateMember(member); // ì¤‘ë³µ íšŒì› ê²€ì¦, ì¤‘ë³µì´ë©´ exception ë°œìƒ
        memberRepository.save(member);

        return member.getId();
    }

    private void validateDuplicateMember(Member member) {
        List<Member> findMembers = memberRepository.findByName(member.getName());
        if(!findMembers.isEmpty()){ // 1ëª… ì´ìƒì¼ë•Œ
            throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
        }
    }

    /**
     * íšŒì› ì „ì²´ ì¡°íšŒ
     */
    public List<Member> findMembers(){
        return memberRepository.findAll();
    }

    /**
     * íšŒì› í•œëª… ì¡°íšŒ
     */
    public Member findOne(Long memberId){
        return memberRepository.findOne(memberId);
    }

}

```

<br>

#### 1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ keyëŠ” IDê°’(DBì˜ PK)

ë”°ë¼ì„œ í•­ìƒ idê°’ì´ ìƒì„±ë˜ì–´ ìˆëŠ”ê²Œ ë³´ì¥ë¨
- ì•„ì§ DBì— ë“¤ì–´ê°„ ì‹œì ì´ ì•„ë‹ˆì–´ë„! 

<br>

#### 2. @Transactional

ê¸°ë³¸ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ë°ì´í„° ë³€ê²½ ì¼ì–´ë‚˜ì•¼ í•¨!
- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ì“°ëŠ”ê²Œ ë‚˜ìŒ

- @Transactional(readOnly = true)
    - ì¡°íšŒ(ì½ê¸°)í• ë•Œ readOnly=trueë¡œ í•˜ë©´ ì¢€ë” ìµœì í•˜í•´ì„œ ë¶€í•˜ë„ ë‚®ì¶”ëŠ” ë“±ì˜ ê¸°ëŠ¥ ì œê³µ
    - ì“°ê¸° í• ë•Œ ì¶”ê°€í•˜ë©´ ë°ì´í„° ë³€ê²½ ì•ˆë¨!! ì‚¬ìš© x

    â¡ï¸ ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ readOnly=trueí•˜ê³  ì“°ê¸°/ë³€ê²½í•˜ëŠ” ë©”ì†Œë“œì— ê·¸ëƒ¥ íŠ¸ëœì­ì…˜ ì ìš©í•´ ìš°ì„ ê¶Œ ì ìš©ì‹œí‚¤ê¸° (ìƒí™©ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ~)


<br>

#### 3. ì¤‘ë³µ íšŒì› ë°©ì§€

- ì¤‘ë³µíšŒì› ë°©ì§€ í•¨ìˆ˜ ë§Œë“¤ì–´ë†”ë„ ë©€í‹°ì“°ë ˆë“œ ë“± ë™ì‹œì— saveí•˜ë©´ ì¤‘ë³µíšŒì›ì´ ê°€ì…ë  ìˆ˜ ìˆìŒ!

    â¡ï¸ ë”°ë¼ì„œ ìµœí›„ì˜ ë°©ì–´ë¡œ DBì—ì„œ memberì˜ nameì„ unique ì œì•½ì¡°ê±´ìœ¼ë¡œ ê±¸ê¸°


#### 4. ìƒì„±ì
```
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class MemberService {

    private final MemberRepository memberRepository;

    ...
}
```
- @RequiredArgsConstructor ì“°ëŠ”ê²Œ ì¢‹ìŒ
- ì›ë˜ ì“°ëŠ” ë°©ë²•ì´ë¯€ë¡œ ì„¤ëª… ìƒëµ


<br><Br>

### íšŒì› ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ 

- @RunWith(SpringRunner.class) : junit ì‹¤í–‰ì‹œ ìŠ¤í”„ë§ì´ë‘ ê°™ì´ ì‹¤í–‰í•˜ê²Œ í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜
- @SpringBootTest : ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ë„ìš´ ìƒíƒœë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- @Transactional : í…ŒìŠ¤íŠ¸ì‹œ ë¡¤ë°± ê°€ëŠ¥í•˜ê²Œ! (ë¡¤ë°±í•˜ë©´ DBì— INSERT ì¿¼ë¦¬ì¡°ì°¨ ì•ˆë‚ ë¦¼)
    - ì¿¼ë¦¬ ë‚ ë¦¬ëŠ”ê±° ë³´ê³ ì‹¶ìœ¼ë©´ em.flush() í˜¹ì€ rollback(false)

```
@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class MemberServiceTest {

    @Autowired MemberService memberService;
    @Autowired
    MemberRepository memberRepository;

    @Autowired
    EntityManager em;

    @Test
    public void íšŒì›ê°€ì…() throws Exception{
        //given ì´ê²Œ ì£¼ì–´ì§ˆë•Œ
        Member member = new Member();
        member.setName("kim");

        //when ì´ë ‡ê²Œ í•˜ë©´
        Long savedId = memberService.join(member);

        //then ì´ë ‡ê²Œ ëœë‹¤
        em.flush(); // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ë³€ê²½/ë“±ë¡ ë‚´ìš©ì„ DBì— ë°˜ì˜ì‹œí‚´
        Assert.assertEquals(member, memberRepository.findOne(savedId));
    }

    ...
}
```


#### ì¤‘ë³µíšŒì› í…ŒìŠ¤íŠ¸
```
@Test
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() throws Exception{
        //given
        Member member1 = new Member();
        member1.setName("kim");

        Member member2 = new Member();
        member2.setName("kim");

        //when
        memberService.join(member1);
        try{
            memberService.join(member2); //ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼í•¨!
        }catch (IllegalStateException e){
            return;
        }


        //then
        fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤."); // ì½”ë“œê°€ ëŒë‹¤ê°€ ì´ ì½”ë“œì— ë„ì°©í•˜ë©´ ì•ˆë˜ëŠ” ê±°ì„

    }


```
: when ì—ì„œ ì˜ˆì™¸ê°€ í„°ì ¸ì„œ catchì—ì„œ returní•´ì•¼í•˜ë¯€ë¡œ fail êµ¬ë¬¸ì— ë„ì°©í•˜ë©´ ì•ˆë¨!!

â¡ï¸ ë” ê°„ë‹¨í•˜ê²Œ ì‘ì„± ë°©ë²•

```
    @Test(expected = IllegalStateException.class)
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() throws Exception{
        //given
        Member member1 = new Member();
        member1.setName("kim");

        Member member2 = new Member();
        member2.setName("kim");

        //when
        memberService.join(member1);
        memberService.join(member2); //ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼í•¨!

        //then
        fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤."); // ì½”ë“œê°€ ëŒë‹¤ê°€ ì´ ì½”ë“œì— ë„ì°©í•˜ë©´ ì•ˆë˜ëŠ” ê±°ì„

    }
```
- (expected = IllegalStateException.class)

    : memberService.join(member2); ì—¬ê¸°ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ë°œìƒí•œ ì˜ˆì™¸ê°€ IllegalStateExceptionë©´ í…ŒìŠ¤íŠ¸ ì„±ê³µ


<br><br>

ğŸ“Œ í…ŒìŠ¤íŠ¸ í• ë•Œ DB ì•ˆë„ìš°ê³  ë‚´ì¥ ë©”ëª¨ë¦¬ë¡œ í•˜ëŠ” ë²•
> TESTì— resources ë””ë ‰í† ë¦¬ ë§Œë“¤ë¡œ application.yml ë³µì‚¬
    
> datasource: url: jdbc:h2:mem:test ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë‚´ì¥ ë©”ëª¨ë¦¬ë¡œ í…ŒìŠ¤íŠ¸í•´ì„œ DB êº¼ì ¸ ìˆì–´ë„ í…ŒìŠ¤íŠ¸ ëŒì•„ê°

> ë˜ëŠ” ê·¸ëƒ¥ data base ì„¤ì • ì—†ìœ¼ë©´ ê·¸ëƒ¥ ìŠ¤í”„ë§ì´ ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ëŒë¦¼(ê·¹ë‹¨ì ìœ¼ë¡œ application.yml ë¹„ì–´ìˆì–´ë„ ë¨)
    